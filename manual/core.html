<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Organization">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta itemprop="name" content="Quasar">
<meta itemprop="description" content="Lightweight threads, CSP and actors for the JVM">
<title>
  
    Quasar Core - 
   Quasar
</title>
<!--<link rel="shortcut icon" href="/images/icons/loading_icon.png">-->
<link href="/quasar/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/quasar/css/pygments/jekyll-github.css"  rel="stylesheet" type="text/css">
<!-- comment out the next line to disable line numbers -->
<link href="/quasar/css/pygments/linenos.css"        rel="stylesheet" type="text/css">
<!-- <link href="/quasar/css/prettify/sunburst.css" rel="stylesheet" type="text/css"> -->
<link href="/quasar/css/site.css?now" rel="stylesheet" type="text/css">



</head>
<body>

<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container-fluid">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
      </a>
      <a class="brand" href="/quasar/">Quasar</a>
      <div class="nav-collapse collapse">
        <ul class="nav">
          <li class="icon github"><a href="https://github.com/puniverse/quasar"><img src="/quasar/images/icons/github.png">View on Github</a></li>
          <li><a href="/quasar/javadoc/index.html">API</a> </li>
          <li class="icon bug"><a href="https://github.com/puniverse/quasar/issues/new"><img src="/quasar/images/icons/bug.png">File a bug</a></li>
          <!-- <li class="icon source"><a href="https://github.com/puniverse/pulsar/blob/master/CONTRIBUTING.md"><img src="/images/icons/source.png">Contribute</a> </li> -->
          <li class="icon talk"><a href="https://groups.google.com/forum/#!forum/quasar-pulsar-user"><img src="/quasar/images/icons/talk.png">Discuss</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>


<div class="container-fluid">
  <div class="row-fluid">
    <div class="span3">
  <div class="well well-small sidebar-nav">
    <ul class="nav nav-list">
      
        <li class="nav-header">Getting Started</li>
        
          
          
            
          
          
          
        
          
          
            
          
          
          
            <li>
              <a  href="/quasar/getting-started.html">
                Getting Started
              </a>
              
            </li>
          
        
          
          
            
          
          
          
        
          
          
            
          
          
          
        
          
          
            
          
          
          
        
          
          
            
          
          
          
            <li>
              <a  href="/quasar/news.html">
                News
              </a>
              
            </li>
          
        
      
        <li class="nav-header">User Manual</li>
        
          
          
            
          
          
          
            <li>
              <a class="active" href="/quasar/manual/core.html">
                Quasar Core
              </a>
              
              <ul class="nav nav-list"><li><a href="#fibers">Fibers</a></li><li><a href="#strands">Strands</a></li><li><a href="#transforming-any-asynchronous-callback-to-a-fiber-blocking-operation">Transforming any Asynchronous Callback to A Fiber-Blocking&nbsp;Operation</a></li><li><a href="#advanced-fibers">Advanced Fiber&nbsp;Usage</a></li><li><a href="#channels">Channels</a></li><li><a href="#delay-variables">Delay&nbsp;Variables</a></li></ul>
              
            </li>
          
        
          
          
            
          
          
          
        
          
          
            
          
          
          
            <li>
              <a  href="/quasar/manual/actors.html">
                Quasar's Actor System
              </a>
              
            </li>
          
        
          
          
            
          
          
          
            <li>
              <a  href="/quasar/manual/cluster.html">
                Clustering
              </a>
              
            </li>
          
        
          
          
            
          
          
          
            <li>
              <a  href="/quasar/manual/examples.html">
                Examples
              </a>
              
            </li>
          
        
          
          
            
          
          
          
        
      
      <li class="divider"></li>
    </ul>
  </div>
</div>

    <div class="span8" id="content-container">

      <span class="edit-on-github">
  <a href="https://github.com/puniverse/quasar/edit/master/docs/manual/core.md">Edit on Github</a>
</span>


      
      <div class="page-header">
        <h1>Quasar Core
          
        </h1>
      </div>
      

      <div id="content">
<h2 id="fibers">Fibers</h2>

<p>Quasar’s chief contribution is that of the lightweight thread, called <em>fiber</em> in Quasar.<br />
Fibers provide functionality similar to threads, and a similar <span class="caps">API</span>, but they’re not managed by the <span class="caps">OS.</span> They are lightweight in terms of <span class="caps">RAM</span> (an idle fiber occupies ~400 bytes of <span class="caps">RAM</span>) and put a far lesser burden on the <span class="caps">CPU</span> when task-switching. You can have millions of fibers in an application. If you are familiar with Go, fibers are like goroutines. Fibers in Quasar are scheduled by one or more <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ForkJoinPool.html">ForkJoinPool</a>s. </p>

<p>Fibers are not meant to replace threads in all circumstances. A fiber should be used when its body (the code it executes) blocks very often waiting on other fibers (e.g. waiting for messages sent by other fibers on a channel, or waiting for the value of a dataflow-variable). For long-running computations that rarely block, traditional threads are preferable. Fortunately, as we shall see, fibers and threads interoperate very&nbsp;well.</p>

<p>Fibers are especially useful for replacing callback-ridden asynchronous code. They allow you to enjoy the scalability and performance benefits of asynchronous code while keeping the simple to use and understand threaded&nbsp;modedl.</p>

<h3 id="using-fibers">Using&nbsp;Fibers</h3>

<p>A fiber is represented by the <a href="/quasar/javadoc/co/paralleluniverse/fibers/Fiber.html"><code>Fiber</code></a> class. Similarly to a thread, you spawn a fiber like&nbsp;so:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="k">new</span> <span class="n">Fiber</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span id="line-2">	<span class="nd">@Override</span>
</span><span id="line-3">	<span class="kd">protected</span> <span class="n">V</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SuspendExecution</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span id="line-4">        <span class="c1">// your code</span>
</span><span id="line-5">    <span class="o">}</span>
</span><span id="line-6"><span class="o">}.</span><span class="na">start</span><span class="o">();</span>
</span></code></pre></div>
<p>There are several differences between this and starting a thread. First, a fiber can have a return value of the generic type <code>V</code> (we’ll shortly see how to use it). If your fiber does not need to return a value, use <code>Void</code> as the type for <code>V</code>, and return <code>null</code> from the <code>run</code> method. Second, the <code>run</code> method is allowed to throw an <code>InterruptedException</code>, (this is mostly a matter of convenience), as well as <code>SuspendExecution</code> which we’ll come back&nbsp;to.</p>

<p>You can also start a fiber by passing an instance of <a href="/quasar/javadoc/co/paralleluniverse/strands/SuspendableRunnable.html"><code>SuspendableRunnable</code></a> or <a href="/quasar/javadoc/co/paralleluniverse/strands/SuspendableCallable.html"><code>SuspendableCallable</code></a> to <code>Fiber</code>’s&nbsp;constructor:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="k">new</span> <span class="n">Fiber</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">SuspendableRunnable</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-2">	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SuspendExecution</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span id="line-3">		<span class="c1">// your code</span>
</span><span id="line-4">	<span class="o">}</span>
</span><span id="line-5"><span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></code></pre></div>
<p>You can join a fiber much as you’d do a thread with the <code>join</code> method. To obtain the value returned by the fiber (if any), you call the <code>get</code> method, which joins the fiber and returns its&nbsp;result.</p>

<p>Other than <code>Fiber</code>’s constructor and <code>start</code> method, and possibly the <code>join</code> and <code>get</code> methods, you will not access the <code>Fiber</code> class directly much. To perform operations you would normally want to do on a thread, it is better to use the <code>Strand</code> class (discussed later), which is a generalizations of both threads and&nbsp;fibers.</p>

<h3 id="thread-locals">Thread&nbsp;Locals</h3>

<p>Using <code>ThreadLocal</code>s in a fiber works as you’d expect – the values are local to the fiber. An <code>InheritableThreadLocal</code> inherits its value from the fiber’s parent, i.e. the thread or the fiber that spawned&nbsp;it.</p>

<h3 id="suspendable-this-suspendable-that">Suspendable This, Suspendable&nbsp;That</h3>

<p>The <code>run</code> method in <code>Fiber</code>, <code>SuspendableRunnable</code> and <code>SuspendableCallable</code> declares that it may throw a <code>SuspendExecution</code> exception. This is not a real exception, but part of the inner working of fibers. Any method that may run in a fiber and may block, declares to throw this exception or is annotated with the <code>@Suspendable</code> annotation. Such a method is called a <em>suspendable method</em>. When a method you write calls a suspendable method, it, too, is a suspendable method, and must therefore declare to throw <code>SuspendExecution</code> (if you cannot add this exception to your method’s <code>throws</code> clause, say, because you’re implementing an interface that does not throw it, you can annotate your method with the <code>@Suspendable</code> annotation, but this requires extra consideration; please see the <a href="#advanced-fibers">Advanced Fiber Usage</a> section). Adding <code>SuspendExecution</code> to the <code>throws</code> clause is convenient because it makes the compiler force you to add the exception to any method that calls your method, which you&nbsp;should.</p>

<p class="alert alert-warning"><strong>Note</strong>: Other than a few methods in the <code>Fiber</code> class that are usually only used internally, whenever you encounter a method that declares to throw <code>SuspendExecution</code>, it is safe to call to use by fibers as well as regular threads. If used in a thread, it will never actually throw a <code>SuspendExecution</code> exception, so it is best to declare a <code>catch(SuspendExecution e)</code> block when called on a regular thread, and just throw an <code>AssertionError</code>, as it should never&nbsp;happen.</p>

<h2 id="strands">Strands</h2>

<p>A <em>strand</em> (represented by the <a href="/quasar/javadoc/co/paralleluniverse/strands/Strand.html"><code>Strand</code></a> class) is an abstraction for both fibers and threads; in short – a strand is either a fiber or a thread. The <code>Strand</code> class provides many useful methods. <code>Strand.currentStrand()</code> returns the current running strand (be it a fiber or a thread); <code>Strand.sleep()</code> suspends the current strand for the given number of milliseconds; <code>getStackTrace</code> returns the current stack trace of the strand. To learn more about what operations you can perform on strands, please consult the <a href="/quasar/javadoc/co/paralleluniverse/strands/Strand.html">Javadoc</a>.</p>

<h3 id="park-and-unpark"><code>park</code> and&nbsp;<code>unpark</code></h3>

<p>Most importantly (though relevant only for power-users who would like to implement their own concurrency primitives, such as locks), the <code>Strand</code> classcontains the methods <code>park</code> and <code>unpark</code>, that delegate to <code>Fiber.park</code> and <code>Fiber.unpark</code> methods if the strand is a fiber, or to <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/LockSupport.html"><code>LockSupport</code></a>’s <code>park</code> and <code>unpark</code> methods if the strand is a thread (<code>LockSupport</code> lies at the core of all <code>java.util.concurrent</code> classes). This allows to create synchronization mechanisms that work well for both fibers and&nbsp;threads. </p>

<p>Just as you almost never use <code>LockSupport</code> directly, so, too, you will never need to call <code>Strand.park</code> or <code>Strand.unpark</code>, unless you’re writing your own concurrency constructs (like a new kind of&nbsp;lock).</p>

<h2 id="transforming-any-asynchronous-callback-to-a-fiber-blocking-operation">Transforming any Asynchronous Callback to A Fiber-Blocking&nbsp;Operation</h2>

<p>As we said above, fibers are great as a replacement for callbacks. The <a href="/quasar/javadoc/co/paralleluniverse/fibers/FiberAsync.html">FiberAsync</a> class helps us easily turn any callback-based asynchronous operation to as simple fiber-blocking&nbsp;call.</p>

<p>Assume that operation <code>Foo.asyncOp(FooCompletion callback)</code> is an asynchronous operation, where <code>Completion</code> is defined&nbsp;as:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">interface</span> <span class="nc">FooCompletion</span> <span class="o">{</span>
</span><span id="line-2">	<span class="kt">void</span> <span class="nf">success</span><span class="o">(</span><span class="n">String</span> <span class="n">result</span><span class="o">);</span>
</span><span id="line-3">	<span class="kt">void</span> <span class="nf">failure</span><span class="o">(</span><span class="n">FooException</span> <span class="n">exception</span><span class="o">);</span>
</span><span id="line-4"><span class="o">}</span>
</span></code></pre></div>
<p>We then define the following subclass of&nbsp;<code>FiberAsync</code>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">class</span> <span class="nc">FooAsync</span> <span class="kd">extends</span> <span class="n">FiberAsync</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">FooException</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">FooCompletion</span> <span class="o">{</span>
</span><span id="line-2">	<span class="nd">@Override</span>
</span><span id="line-3">	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">success</span><span class="o">(</span><span class="n">String</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-4">		<span class="n">asyncCompleted</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span><span id="line-5">	<span class="o">}</span>
</span><span id="line-6"> 
</span><span id="line-7"> 	<span class="nd">@Override</span>
</span><span id="line-8"> 	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">failure</span><span class="o">(</span><span class="n">FooException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-9"> 		<span class="n">asyncFailed</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
</span><span id="line-10"> 	<span class="o">}</span>
</span><span id="line-11"><span class="o">}</span>
</span></code></pre></div>
<p>Then, to transform the operation to a fiber-blocking one, we can&nbsp;define:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">String</span> <span class="nf">op</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-2">	<span class="k">new</span> <span class="nf">FooAsync</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-3">		<span class="kd">protected</span> <span class="n">Void</span> <span class="nf">requestAsync</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-4">        	<span class="n">Foo</span><span class="o">.</span><span class="na">asyncOp</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span id="line-5">     	<span class="o">}</span>
</span><span id="line-6">	<span class="o">}.</span><span class="na">run</span><span class="o">();</span>
</span><span id="line-7"><span class="o">}</span>
</span></code></pre></div>
<p>The call to <code>run</code> will block the fiber until the operation&nbsp;completes.</p>

<p>Transforming asynchronous code to fiber-blocking calls has a negligible overhead both in terms of memory and performance, while making the code shorter and far simpler to&nbsp;understand.</p>

<h2 id="advanced-fibers">Advanced Fiber&nbsp;Usage</h2>

<h3 id="fiber-internals">Fiber&nbsp;Internals</h3>

<p>We will now cover in some depth the inner workings of Quasar fibers. You should read this section if you’d like to annotate suspendable methods with the <code>@Suspendable</code> annotation rather than by declaring <code>throws SuspendExecution</code>, or if you’re just&nbsp;curious.</p>

<p>Internally, a fiber is a <em>continuation</em> which is then scheduled in a scheduler. A continuation captures the instantaneous state of a computation, and allows it to be suspended and then resumed at a later time from the point where it was suspended. Quasar creates continuations by instrumenting (at the bytecode level) suspendable methods. For scheduling, Quasar uses <code>ForkJoinPool</code>, which is a very efficient, work-stealing, multi-threaded&nbsp;scheduler.</p>

<p>Whenever a class is loaded, Quasar’s instrumentation module (usually run as a Java agent) scans it for suspendable methods. Every suspendable method <code>f</code> is then instrumented in the following way: It is scanned for calls to other suspendable methods. For every call to a suspendable method <code>g</code>, some code is inserted before (and after) the call to <code>g</code> that saves (and restores) the state of a local variables to the fiber’s stack (a fiber manages its own stack), and records the fact that this (i.e. the call to <code>g</code>) is a possible suspension point. At the end of this “suspendable function chain”, we’ll find a call to <code>Fiber.park</code>. <code>park</code> suspends the fiber by throwing a <code>SuspendExecution</code> exception (which the instrumentation prevents you from catching, even if your method contains a <code>catch(Throwable t)</code>&nbsp;block).</p>

<p>If <code>g</code> indeed blocks, the <code>SuspendExecution</code> exception will be caught by the <code>Fiber</code> class. When the fiber is awakened (with <code>unpark</code>), method <code>f</code> will be called, and then the execution record will show that we’re blocked at the call to <code>g</code>, so we’ll immediately jump to the line in <code>f</code> where <code>g</code> is called, and call it. Finally, we’ll reach the actual suspension point (the call to <code>park</code>), where we’ll resume execution immediately following the call. When <code>g</code> returns, the code inserted in <code>f</code> will restore <code>f</code>’s local variables from the fiber&nbsp;stack.</p>

<p>This process sounds complicated, but its incurs a performance overhead of no more than&nbsp;3%-5%.</p>

<h3 id="suspendable">@Suspendable</h3>

<p>So far, our way to specify a suspendable method is by declaring it throws <code>SusepndExecution</code>. This is convenient because <code>SuspendExecution</code> is a checked exception, so if <code>f</code> calls <code>g</code> and <code>g</code> is suspendable, the Java compiler will force us to declare that <code>f</code> is suspendable (and it must be because it calls <code>g</code> and <code>g</code> might be&nbsp;suspended).</p>

<p>Sometimes, however, we cannot declare <code>f</code> to throw <code>SuspendExecution</code>. One example is that <code>f</code> is an implementation of an interface method, and we cannot (or don’t want to) change the interface so that it throws <code>SuspendExecution</code>. It is also possible that we want <code>f</code> to be run in regular threads as well as&nbsp;fibers. </p>

<p>An example for that are the synchronization primitives in the <code>co.paralleluniverse.strands.concurrent</code> package, which implement interfaces declared in <code>java.util.concurrent</code>, and we want to maintain compatibility. Also, no harm will come if we use these classes in regular threads. They will work just as well for threads as for fibers, because internally they call <code>Strand.park</code> which is fiber-blocking (suspends) if run in a fiber, but simply blocks the thread if&nbsp;not.</p>

<p>So, suppose method <code>f</code> is declared in interface <code>I</code>, and we’d like to make its implementation in class <code>C</code> suspendable. The compiler will not let us declare that we throw <code>SuspendExecution</code> because that will conflict with <code>f</code>’s declaration in&nbsp;<code>I</code>.</p>

<p>What we do, then, is annotate <code>C.f</code> with the <code>co.paralleluniverse.fibers.@Suspendable</code> annotation. Assuming <code>C.f</code> calls <code>park</code> or some other suspendable method <code>g</code> – which does declare <code>throws SuspendExecution</code>, we need to surround <code>f</code>’s body with <code>try {} catch(SuspendExecution)</code> just so the method will compile, like&nbsp;so:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">class</span> <span class="nc">C</span> <span class="kd">implements</span> <span class="n">I</span> <span class="o">{</span>
</span><span id="line-2">	<span class="nd">@Suspendable</span>
</span><span id="line-3">	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">f</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-4">		<span class="k">try</span> <span class="o">{</span>
</span><span id="line-5">			<span class="c1">// do some stuff</span>
</span><span id="line-6">			<span class="k">return</span> <span class="nf">g</span><span class="o">()</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>
</span><span id="line-7">		<span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">SuspendExecution</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-8">			<span class="k">throw</span> <span class="k">new</span> <span class="nf">AssertionError</span><span class="o">(</span><span class="n">s</span><span class="o">);</span> 
</span><span id="line-9">		<span class="o">}</span>
</span><span id="line-10">	<span class="o">}</span>
</span><span id="line-11"><span class="o">}</span>
</span></code></pre></div>
<p>The <code>catch</code> block will never be executed; the intstrumentation will take care of&nbsp;that.</p>

<p>But now let’s consider method&nbsp;<code>h</code>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nd">@Suspendable</span>
</span><span id="line-2"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">h</span><span class="o">(</span><span class="n">I</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-3">	<span class="n">x</span><span class="o">.</span><span class="na">f</span><span class="o">();</span>
</span><span id="line-4"><span class="o">}</span>
</span></code></pre></div>
<p>First, if we want to run <code>h</code> in a fiber, then it must be suspendable because it calls <code>f</code> which is suspendable. We could designate <code>h</code> as suspendable either by annotating it with <code>@Suspendable</code> or by declaring <code>throws SuspendExecution</code> (even though <code>f</code> is not declared to throw&nbsp;<code>SuspendExecution</code>).</p>

<p>When <code>h</code> is encountered by the instrumentation module, it will be instrumented because it’s marked suspendable, but in order for the instrumentation to work, it needs to know of <code>h</code>’s calls to other instrumented methods. <code>h</code> calls <code>f</code>, which is suspendable, but through its interface <code>I</code>, while we’ve only annotated <code>f</code>’s <em>implementation</em> in class C. The instrumenter does not know that <code>I.f</code> has an implementation that might&nbsp;suspend.</p>

<p>Therefore, if you’d like to use the <code>@Suspendable</code> annotation, there’s a step you need to add to your build step, after compilation and before creating the jar file: running the class <code>co.paralleluniverse.fibers.instrument.SuspendablesScanner</code>. In Gradle it looks like&nbsp;this:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">task</span> <span class="nf">scanSuspendables</span><span class="o">(</span><span class="nl">type:</span> <span class="n">JavaExec</span><span class="o">,</span> <span class="nl">dependsOn:</span> <span class="n">classes</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// runs SuspendableScanner</span>
</span><span id="line-2">    <span class="n">main</span> <span class="o">=</span> <span class="s2">&quot;co.paralleluniverse.fibers.instrument.SuspendablesScanner&quot;</span>
</span><span id="line-3">    <span class="n">classpath</span> <span class="o">=</span> <span class="n">sourceSets</span><span class="o">.</span><span class="na">main</span><span class="o">.</span><span class="na">runtimeClasspath</span>
</span><span id="line-4">    <span class="n">args</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;package1&quot;</span><span class="o">,</span> <span class="s2">&quot;package2&quot;</span><span class="o">]</span>
</span><span id="line-5"><span class="o">}</span>
</span></code></pre></div>
<p>Where <code>"package1"</code> and <code>"package2"</code> are packages that contain methods annotated with&nbsp;<code>@Suspendable</code>. </p>

<p><code>SuspendablesScanner</code> scans your code after it’s been compiled for methods annotated with <code>@Suspendable</code>. In our example it will find <code>C.f</code>. It will then see that <code>C.f</code> is an implementation of <code>I.f</code>, and so it will list <code>I.f</code> in a text file (<code>META-INF/suspendable-supers</code>), that contains all methods that have overriding suspendable&nbsp;implementations. </p>

<p>When the instrumentation module instruments <code>h</code>, it will find <code>I.f</code> in the file, and, knowing it might suspend, inject the appropriate&nbsp;code.</p>

<p>Note that this has no effect on other calls to <code>I.f</code>. The instrumentation module only cares that <code>I.f</code> has suspendable implementations when it finds it called in suspendable methods (in our case:&nbsp;<code>h</code>).</p>

<h2 id="channels">Channels</h2>

<p>Channels are queues used to pass messages between strands (remember, strands are a general name for threads and fibers). If you are familiar with Go, Quasar channels are like Go&nbsp;channels. </p>

<p>A <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channel.html">channel</a> is an interface that extends two other interfaces: <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/SendPort.html"><code>SendPort</code></a>, which defines the methods used to send messages to a channel, and <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/ReceivePort.html"><code>ReceivePort</code></a>, which defines the methods used to receive messages from a&nbsp;channel.</p>

<p>Channels are normally created by calling any of the <code>newChannel</code> static methods of the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html"><code>Channels</code></a> class. The <code>newChannel</code> methods create a channel with a specified set of properties. Those properties&nbsp;are:</p>

<ul>
  <li><code>bufferSize</code> – if positive, the number of messages that the channel can hold in an internal buffer; <code>0</code> for a <em>transfer</em> channel, i.e. a channel with no internal buffer. or <code>-1</code> for a channel with an unbounded (infinite)&nbsp;buffer.</li>
  <li><code>policy</code>         – the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/OverflowPolicy.html"><code>OverflowPolicy</code></a> specifying how the channel (if bounded) will behave if its internal buffer&nbsp;overflows.</li>
  <li><code>singleProducer</code> – whether the channel will be used by a single producer&nbsp;strand.</li>
  <li><code>singleConsumer</code> – whether the channel will be used by a single consumer&nbsp;strand.</li>
</ul>

<p>Note that not all property combinations are supported. Consult the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html"><code>Javadoc</code></a> for&nbsp;details.</p>

<h3 id="sending-and-receiving-messages">Sending and Receiving&nbsp;Messages</h3>

<p>Messages are sent to a channel using the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/SendPort.html#send(Message)"><code>SendPort.send</code></a> method. The <code>send</code> method blocks if the channel’s buffer is full and the channel has been configured with the <code>BLOCK</code> overflow policy. There are versions of <code>send</code> that block indefinitely or up to a given timeout, and the <code>trySend</code> method sends a message if the channel’s buffer has room, or returns immediately, without blocking, if not. Consult the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/SendPort.html">Javadoc</a> for&nbsp;details.</p>

<p>Messages are received from a channel using the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/ReceivePort.html#receive()"><code>ReceivePort.receive</code></a> method. There are versions of <code>receive</code> that block indefinitely or up to a given timeout, and the <code>tryReceive</code> method receives a message if one is available, or returns immediately, without blocking, if not. Consult the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/ReceivePort.html">Javadoc</a> for&nbsp;details.</p>

<p>Close&nbsp;<span class="caps">XXXXX</span></p>

<p class="alert alert-info"><strong>Note</strong>: As usual, while the blocking channel methods declare to throw <code>SuspendExecution</code>, this exception will never actually be thrown. If using channels in a plain thread, you should <code>catch(SuspendExecution e) { throw AssertionError(); }</code>. Alternatively, you can use the convenience wrappers <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/ThreadReceivePort.html"><code>ThreadReceivePort</code></a> and <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/ThreadSendPort.html"><code>ThreadSendPort</code></a>.</p>

<h3 id="primitive-channels">Primitive&nbsp;Channels</h3>

<p>Quasar provides 4 types of channels for primitive data types: <code>int</code>, <code>long</code>, <code>float</code> and <code>double</code>. Consult the Javadoc of, for example, <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/IntSendPort.html"><code>IntSendPort</code></a> <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/IntReceivePort.html"><code>IntReceivePort</code></a> and for&nbsp;details.</p>

<p>All primitive channels do not support multiple&nbsp;consumers.</p>

<h3 id="ticker-channels">Ticker&nbsp;Channels</h3>

<p>A channel created with the <code>DISPLACE</code> overflow policy is called a <em>ticker channel</em> because it provides guarantees similar to that of a digital stock-ticker: you can start watching at any time, the messages you read are always read in order, but because of the limited screen size, if you look away or read to slowly you may miss some&nbsp;messages.</p>

<p>The ticker channel is useful when a program component continually broadcasts some information. The size channel’s circular buffer, its “screen” if you like, gives the subscribers some leeway if they occasionally fall behind&nbsp;reading.</p>

<p>A ticker channel is single-consumer, i.e. only one strand is allowed to consume messages from the channel. On the other hand, it is possible, and useful, to create several views of the channel, each used by a different consumer strand. A view (which is of type <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/TickerChannelConsumer.html"><code>TickerChannelConsumer</code></a> is created with the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html#newTickerConsumerFor(Channel)"><code>Channels.newTickerConsumerFor</code></a>&nbsp;method.</p>

<p>The method returns a <code>ReceivePort</code> that can be used to receive messages from <code>channel</code>. Each ticker-consumer will yield monotonic messages, namely no message will be received more than once, and the messages will be received in the order they’re sent, but if the consumer is too slow, messages could be&nbsp;lost. </p>

<p>Each consumer strand will use its own <code>ticker-consumer</code>, and each can consume messages at its own pace, and each <code>TickerChannelConsumer</code> port will return the same messages (messages consumed from one will not be removed from the other views), subject possibly to different messages being missed by different consumers depending on their&nbsp;pace.</p>

<h3 id="transofrming-channels">Transofrming&nbsp;Channels</h3>

<p>The <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html"><code>Channels</code></a> class has several static methods that can be used to manipulate and compose values sent to or received off&nbsp;channels:</p>

<ul>
  <li>map - returns a channel that transforms messages by applying a given mapping function. There are two versions of <code>map</code>: <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html#map(co.paralleluniverse.strands.channels.ReceivePort, com.google.common.base.Function)">one that operates</a> on <code>ReceivePort</code> and <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html#map(co.paralleluniverse.strands.channels.SendPort, com.google.common.base.Function)">one that operates</a> on&nbsp;<code>SendPort</code>.</li>
  <li><code>filter</code> - returns a channel that only lets messages that satisfy a predicate through. There are two versions of <code>filter</code>: <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html#filter(co.paralleluniverse.strands.channels.ReceivePort, com.google.common.base.Predicate)">one that operates</a> on <code>ReceivePort</code> and <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html#filter(co.paralleluniverse.strands.channels.SendPort, com.google.common.base.Predicate)">one that operates</a> on&nbsp;<code>SendPort</code>.</li>
  <li><a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html#zip(com.google.common.base.Function, co.paralleluniverse.strands.channels.ReceivePort...)"><code>zip</code></a> - returns a channel that combines each vector of messages from a vector of channels into a single combined&nbsp;message.</li>
  <li><a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Channels.html#group(co.paralleluniverse.strands.channels.ReceivePort...)"><code>group</code></a> - returns a channel that funnels messages from a set of given&nbsp;channels.</li>
</ul>

<h3 id="channel-selection">Channel&nbsp;Selection</h3>

<p>A powerful tool when working with channels is the ability to wait on several channel operations at once. If you are familiar with the Go programming language, this capability is provided by the <code>select</code>&nbsp;statement.</p>

<p>The <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Selector.html"><code>Selector</code></a> class exposes several static methods that allow <em>channel selection</em>. The basic idea is this: you declare several channel operations (sends and receives), each possibly operating on a different channel, and then use <code>Selector</code> to perform at most&nbsp;one.</p>

<p>Here is an example of using <code>Selector</code>. For details, please consult the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/Selector.html">Javadoc</a>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">SelectAction</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">Selector</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">ch1</span><span class="o">),</span> <span class="n">Selector</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">ch2</span><span class="o">,</span> <span class="n">msg</span><span class="o">));</span>
</span></code></pre></div>
<p>The example will do exactly one of the following operations: send <code>msg</code> to <code>ch1</code> or receive a message from&nbsp;<code>ch2</code>.</p>

<h2 id="delay-variables">Delay&nbsp;Variables</h2>

<p>Delay variables, delayed values, or dataflow variables (represented by the <a href="/quasar/javadoc/co/paralleluniverse/strands/channels/DelayedVal.html"><code>DelayedVal</code></a> class) are a simple and effective strand coordination mechanism. A <code>DelayedVal</code> can have its value set once, and when read, blocks until the value is set. <code>DelayVal</code> implements&nbsp;<code>j.u.c.Future</code>.</p>

</div>

      <hr>

      <footer>
        <div>
          <div>&copy; 2013, Parallel Universe Software Co.</div>
        </div>
      </footer>

    </div>
  </div>
</div>

<!-- <script src="/quasar/js/prettify/prettify.js"></script> -->
<script src="/quasar/js/jquery.min.js"></script>
<script src="/quasar/bootstrap/js/bootstrap.min.js"></script>
<script src="/quasar/js/bootstrap-scrollspy.js"></script>
<script>


  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25007319-2']);
  _gaq.push(['_trackPageview']);
  
  (function() {
    var ga = document.createElement('script'); 
    ga.type = 'text/javascript'; 
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; 
    s.parentNode.insertBefore(ga, s);
  })();


// Change "active" style on selected left-hand navigation menu item.
$(document).ready(function () {
  var path = location.pathname;
  $('ul.nav > li > a[href="' + path + '"]').parent().addClass('active');

  // TODO: Use kramdown {:.prettyprint .linenums .lang-ruby} to add the
  // <pre class="prettyprint"> instead of doing this client-side.

  // $('pre:has(code:not(.language-txt))').addClass('prettyprint');
  // window.prettyPrint && prettyPrint();
});
</script>

</body>
</html>
